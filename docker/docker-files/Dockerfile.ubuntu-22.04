# syntax=docker/dockerfile:1.3-labs

############## STAGE 1 - Prepare the image for GCS installation ################
FROM ubuntu:22.04

# Prereqs
RUN <<EOF
    set -e
    apt update
    # Resolves: "debconf: (Can't locate Term/ReadLine.pm in @INC" from python install
    apt install -y libterm-readline-gnu-perl
    apt install -y coreutils gzip python3 python3-venv sudo tar
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
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
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    # Install wheel to avoid the warning that setup.py is being used when
    # installing Ansible
    /venv/bin/pip install wheel
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

ARG GLOBUS_ANSIBLE_OPTIONS

# Modifying this arg value on the build command line will cause RUN to reinstall
# Globus instead of using the previous, cached iteration (if it exists). Useful
# for speeding up re-runs to get newer Globus versions.
ARG CACHEBUST=1

RUN <<EOF
    (cd /ansible; /venv/bin/ansible-playbook playbook.yml ${GLOBUS_ANSIBLE_OPTIONS})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
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
YTyMh/Ewvm78B7xmstMAKAAA
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overriden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overriden with 'docker run arg1...'
CMD []
