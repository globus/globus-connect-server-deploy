# syntax=docker/dockerfile:1.3-labs

######################## STAGE 0 - Build the base image ####################### 

ARG BOOTSTRAP_IMAGE=almalinux:9
ARG YUM_OPTIONS='-c /yum/centos-9.repo --releasever=9-stream'
ARG RELEASE_PKG=centos-release

################################################################################
# We build the target image in 2 phases:
#
# - The first stage will create a root of the target distro using the base
#   image's commands. This results in a root that contains the yum/rpm commands
#   of the target distro but with a rpm database in the format used by the base
#   distro.
# - The second stage will copy the root to / to create the final image.
#
# We'll want to do this twice if the BOOTSTRAP_IMAGE is a different major number
# than the target image because the yum/rpm database format changes between
# releases so we'll want the final image to have been built by that distro's
# tools.
################################################################################

# Stage 1: Install the target distro into /$ROOT
FROM ${BOOTSTRAP_IMAGE} as stage_build_root

ARG BOOTSTRAP_IMAGE_PREREQS
ARG RELEASE_PKGS
ARG YUM_OPTIONS

ARG ROOT=/ROOT

# This is the base64 of partials/yum/
COPY <<EOF /yum.64
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
+AvwvwH5BhDZAHgAAA==
EOF

RUN <<EOF
    set -e

    if [ -n "${BOOTSTRAP_IMAGE_PREREQS}" ]
    then
        yum install -y ${BOOTSTRAP_IMAGE_PREREQS}
    fi

    # Yum repo definitions
    cat /yum.64 | base64 -d | (cd /; tar zxf -)
    mkdir -p ${ROOT}/var/lib/rpm
    rpm --root ${ROOT} --initdb

    # Create these /dev/ entries to avoid 3rd party postinstall warnings
    DEV_LIST="null urandom"

    # Create /dev/ in ROOT
    if [ ! -d ${ROOT}/dev ]; then
        mkdir ${ROOT}/dev
        chmod 755 ${ROOT}/dev
    fi

    # Create the /dev/ entries we need
    for dev in ${DEV_LIST}; do
        if [ ! -c ${ROOT}/dev/${dev} ]; then
            mknod ${ROOT}/dev/${dev} c `stat /dev/${dev} --format="%t %T"`
            chmod 666 ${ROOT}/dev/${dev}
            declare ${dev}_CREATED=1
        fi
    done

    yum -y ${YUM_OPTIONS} --installroot ${ROOT} install ${RELEASE_PKGS} yum

    # Delete any /dev/ entries we create above since they may have incorrect
    # major/minor device numbers for the target distro (they'll have the major/minor
    # device numbers of the bootstrap distro).
    for dev in ${DEV_LIST}; do
        varname=${dev}_CREATED
        if [ "${!varname}" = "1" ]; then
            rm -f /dev/${dev}
        fi
    done
EOF

# Stage 2: Copy /$ROOT from stage 1 to /
FROM scratch as base_image

ARG ROOT=/ROOT
COPY --from=stage_build_root ${ROOT} /

############## STAGE 1 - Prepare the image for GCS installation ################
FROM base_image

# Prereqs
RUN <<EOF
    dnf install -y coreutils gzip python3 sudo tar util-linux
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
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
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    # Install wheel to avoid the warning that setup.py is being used when
    # installing Ansible
    /venv/bin/pip install wheel
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

# Modifying this arg value on the build command line will cause RUN to reinstall
# Globus instead of using the previous, cached iteration (if it exists). Useful
# for speeding up re-runs to get newer Globus versions.
ARG CACHEBUST=1
ARG GCS_PROXY
ARG GCS_REPO

RUN <<EOF
    ANSIBLE_CMD="/venv/bin/ansible-playbook playbook.yml"
    if [ -n "$GCS_REPO" ]; then ANSIBLE_CMD="${ANSIBLE_CMD} -e gcs_repo=${GCS_REPO}"; fi
    # Pass on proxy support if requested. Used for the pre-stable repo
    if [ -n "$GCS_PROXY" ]; then ANSIBLE_CMD="${ANSIBLE_CMD} -e gcs_proxy=${GCS_PROXY}"; fi
    (cd /ansible; ${ANSIBLE_CMD})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
H4sIAAAAAAAAA+1ZbXPbuBHO1+Ov2MieyJ6GlOSLk45bXye1dTnPxS9jO01v7joKREISThTIAqAU
Xa//vbsASJGSnJeJ005njA+WBCz2DbvPLmAujVrmmZAm0pNHX2d0cbw4PKTP3ovDbv2Tvj7vPu8+
6j17cfji2+fdbw+ePer2nnUPnz+C7lfSpzEKbZgCePQr05lkqbmL7mPr/6dj53FnKGRnyPQkCHbu
dwQ78Pbl9cXZxasjeM0KGU+EHMOrkxtYCDPJCgN6qQ2fJSA08Pc5V2LGpWFpBG80B2ZgmRUKsoUE
JfQ0Qn4n2SxnRgxTbnlYZofRs+ig94d71z4gA24nHHKm2IwbrjQsOEjOEzAZpNYiaMss4aC5KfI2
MEXUWiOFkDAXDLicC5VJsgu5zZkSDJXXaAvyh91Xry//+uZmcPL6rH9xOzg7hWP4c5wKpB6I5LtN
ipv+yXX/tkaleay4sZSn/avXlz+dE9mP/Z+IhsvEpvYg4XmaLUmJwZQvLfXF5Wkf2d2+uRq8vH51
g+RZbgSFOFox1jDKVNO2Pf4+gjAUeciSRHGt92vq3Zz+OOhf/O3s+vKCFKhzS/icp1lOwhveCMQI
fobwN2hteKEF/wjMhMsAcPB4kkHrXGhN0VPjUHkT2usM2hH03wtjcEfUclzwJ/SCkbhbrvPtF8p2
TD5RfvPEPltyc/sHZd53buzAzW3/CnpHmJFyJMYFBj7qDjZgKHRepdmw0DBcgiqkJBvqwfR1cvUi
UzOWpsun0B5b8WGcScljE2qu5lxBPZwXIk0hL/BPQgBTKt/WXnXkF3vTGEUyMJmUOY9CEAZizAGm
lpBmMYY5iRA4FcEP2QJDXj0FPLqYE2QgLCC7Raam5AimsgJ5kcQCYS4brWBQQqYSVBThZcLmuFFC
IXMl5iLlYwQV1MgwIZE58eOOyBLLJLUngAyRV64BkVPzdF5BjYNdVDye8Hhqz4g0wBhBetIT9TAT
BOKRSC3PGZsiL3ewOC3IIwwn8jxTBnXJU2aQyyyCc6LEUGMwsnsy3IHgjfrFaIDXzfsHmXgn1hRU
MwhHYAuRc0Vs0iCVEGo3aVTB15eR0RVWECoQK3QDRDf0ImrPnB2LCUcDGjhGOinOUANhgiYwHrc6
q4kQJ6Jfsei3ApuM6/j6Hew2dwfxZJYl8Lzb3VgJPhaPlK7wi83aMGzqsM7Mk60DuMeV3b9AKDl0
N7GkJmzE0DeJw4v/JlwclH2ATaZZJoXBMCwzh8Ifi1pRy4ivgBOkzc5OqQdlxTmTbMyVXbKuajeb
Fb/eLhsCmww2eV5enUGuMgICF/IIDNlCU9tCGcSSmZCUXj7VfDXeRBbqKzAz8ZMV2Bgp8RvJRnBQ
JV8MYhaTHFqwXVGNW2FnScStYlKPeOVTn/slvvD3PC4Menoc68HMmRXpLJ5yY08EWwlGyx3E7M46
DaCmKBjZDfmEpaMIzgw5oqBuh+AkzmazQorYGTXkZsE5GpdjqvHOxJg8sUJIz5pbqauz8oiXzBA2
lDC2vmHtQB0WfAjULI4nBCwYoZS/ROeUtey8CcIgoIwi17Upjjrxp4RCs2zeoNsjNXKRWIjYtyeF
uDaERChMzgwhnQjGYm4VPSeoRZ3KE4iIu7To5jTAzctZKuS0splkZakzV/KFrRDkFI0aIDd3pHW/
kE3aEDqPhHeR0zUKgtkU9do4EgQbKlvOQUfeTxtEHkPXpjv2OLceMkWLTw2rhA8juOEIwKkYegBO
/Gdzv0f4PYsmcQId7AE7Dvk6eoIx3EEl/2RXUTaFN4RFecbhuPoWNnYS7I8prjIlPfY5mKR6Shny
DD4+fgm+CcNcYSPK8FhyMWB5/vENCeMIUp/AvtyAuibHqOv7o+0+31QJo3CDFCeDfTqJtwzjvazU
ZcBiTRN4PFqMsbvGiCpsVI6K1BfWANeR6md4bIvqFuZYG5LMOlKnnOfQjQ5xQvKgRjdAuuN3GLZb
ObwLbLu1wGaCyTGnKxqexETkrouoMq1sBVyw2zCnlkcYStJPiinLp1ZZO9j+bvWtb6vR4kLjDEWN
k3pQL4U7cMqHgsnOm2EhTeGaaWmwB7Exa3NqsVjgyRt2VH75gFCeau4ZX/METe2cYJm+vOl8z5NM
sa38nVpH3id38/aFeL1cvcQioA0j5L+jYFUUVLJcwSqrlF7KuOxw16pQCV7UJ2gL7rZd1Jz63myM
nGbU8I6xPiBiapPQBd7FIpWnQhfUe+MZI1QbAu+y6hAKamrOMmrMXDlChihCIgFLnlJBa1tRZQuL
yytp9qLfTigSFK3oNnaMn4kfW9svVvoJnjRCv5q3SbD7ONg4h5fu7Cx4bz2GOkE7+MLY9IVWs5Ft
zCmD3Hbqg2nnOlucB3rWMnYVjSDcOK4izcsuPyPCm08NZEtjzXHwwk3cyaeiY1LdibkyumOvQ5NM
myhWBu2jDZWNToJjDX/EK1GBZdLeYnBTSg8rE9tbKVfwq26/3GstRcygTsbVzlDrNBzTDUZ57TBv
nJiVM9Bleo3bymfuFLd6yi65v9ZLlJINeN31W+6EVLt3BaYl/bvN1FYi+f72antSuzVETIrb9sei
32QFMrRGELxuDX6Cm7CEmzHyH5mcbhvByi9+X7nok8ZfUm7KL7GLAU8VEaaUSyfNpaScL33mYG+b
FOvsbYXsLuK7S5ojXS9nd/F5F3yNy49tRymF40IpjH2ESZmVV2lb4C/PTk/WX0Wj+7/9jDCiLNgL
PfAlYcBSbHT39oN/WfdNCfNDvMH28IKLt+F5R9IbycF3T3rBv2sM7CtCyaPavUP7QrhgsxJMdg/w
99XZaeCAY00sLq8ApXZ13cAMd4VF5nRJpdeHQtKDcYxf02WrIlN4vcUusVfHAT/XJfX1pLAPZAN6
8znu1sxJOZNFXhni5N14cvtEFEX+ntxk4mQZxXI09LZ/fV7/3f/72W1QbSL6Qa3QoALbnbLWh8GT
J9v392rO20YAIf8n9O725y1XeENlZu2mC3skdF2L/ZWbXZCQsRtUQUU0EkpjBcVi6vWk4VL6qPrt
k7Ycn+SKIV67psE3RL+3t7sSs79Pq84y6pzJKjzaumFYPSmAWm53TcNuTSPJ19xU5zBhuozBVhll
LtTvMU9d6rzlqIy7Epf3gLIQGH/Pt60Y3rvzlBse3bsetVS49q+49hXJZwtUKfGB5y1PS9lnk6Lc
a1OlMWOTxc602/DDm6vq+9kFJtHqKKpH0NrdBxHVvZLRsZR1Y7eRqTYZuqtC0UAwaNU7thbsVnUb
fv99a8avba/FSGszaj+bx6qHX+PW6E238V2DhKb5W7GgPCF72GUbaDHLltIKTG1m/K//X/kwHsbD
eBgP42E8jIfxML5s/Aebis1+ACgAAA==
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overridden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overridden with 'docker run arg1...'
CMD []
