# syntax=docker/dockerfile:1.3-labs

############### STAGE 1 - Prepare the image for GCS installation ###############
FROM almalinux:8

# Prereqs
RUN <<EOF
    # Ansible 2.12 will require python38 or newer
    dnf install -y coreutils-single gzip python39 sudo tar util-linux
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
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
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    # Install wheel to avoid the warning that setup.py is being used when
    # installing Ansible
    /venv/bin/pip install wheel
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

ARG GLOBUS_ANSIBLE_OPTIONS

# Modifying this arg value on the build command line will cause RUN to reinstall
# Globus instead of using the previous, cached iteration (if it exists). Useful
# for speeding up re-runs to get newer Globus versions.
ARG CACHEBUST=1

RUN <<EOF
    (cd /ansible; /venv/bin/ansible-playbook playbook.yml ${GLOBUS_ANSIBLE_OPTIONS})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
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
eBgP42E8jIfxML5s/Aebis1+ACgAAA==
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overridden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overridden with 'docker run arg1...'
CMD []
